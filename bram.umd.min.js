(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(Q,R){return Array.isArray(Q)&&!isNaN(+R)}function d(Q){return Array.isArray(Q)||'object'==typeof Q}function e(Q,R){var S=new Proxy(Q,{get:function(T,U){return A.observe(S,U),T[U]},set:function(T,U,V){var W=T[U];// If the value hasn't changed, nothing else to do
return!(!E(V)&&d(V)&&(V=D(V)),T[U]=V,V!==W)||(c(T,U)?R({prop:C,index:+U,type:'set'},V):R({prop:U,type:'set'},V),!0)},deleteProperty:function(T,U){return c(T,U)&&R({prop:C,index:+U,type:'delete'}),!0}});return S}function f(Q){return Q?Object.keys(Q).reduce(function(S,T){var U=Q[T];return S[T]=Array.isArray(U)||'object'==typeof U?D(U):U,S},Q):Q}function g(Q,R,S){var V=Object.keys(R);if(0!==V.length){function ca(ea){if(X++,W===X){var fa=R[W];fa(ea,S,Q),W=+V.shift()}return!W}function da(ea){var fa,ga=z.call(ea.attributes||[]);if(y.call(ga,function(){if(fa=ca(ea),fa)return!0}),fa)return!1;for(var ia,ha=ea.firstChild;ha&&(ia=ha.nextSibling,fa=ca(ha),!fa)&&(fa=!da(ha),!fa);)ha=ia;return!fa}var W=+V.shift(),X=0;da(Q.tree)}}function h(Q){for(var X,R=0,S=Q.length,T=new I,U=!1,V='',W=0;R<S;){if(V=X,X=Q[R],!U){if('$'===X){R++;continue}else if('{'===X&&'$'==V){T.hasBinding=!0,W=T.raw.length,null!=T.values[W]&&W++,T.values[W]='',U=!0,R++;continue}else'$'==V&&(T.raw+=V);T.raw+=X}else{if(U&&'}'===X){U=!1,R++;continue}T.values[W]+=X}R++}return T.includesNonBindings=0<T.raw.length,T}function j(Q,R,S,T){var U=R.compute(Q),V=function(){T(U())};R.props().forEach(function(W){var X=Q.readInTransaction(W),Y=X.model;if(!1!==X.bindable){var Z=new Map;X.reads.forEach(function($){var aa=$[0],ba=$[1];if(Z.has(aa)){var ca=Z.get(aa);if(ca.has(ba))return;ca.set(ba,!0)}else{var ca=new Map;ca.set(ba,!0),Z.set(aa,ca)}S.on(aa,ba,V)})}}),V()}function k(Q,R,S){var T={};switch(Q.nodeType){// Element
case 1:var U;if('TEMPLATE'===Q.nodeName&&(U=m(Q))){var V=Q.getAttribute(U),W=h('${'+V+'}');W.hasBinding&&(W.throwIfMultiple(),T[U]=!0,S[R.id]=function(Y,Z,$){'each'===U?J.each(Y,Z,W,$):j(Z,W,$,J[U](Y,Z,$))})}break;// TextNode
case 3:var W=h(Q.nodeValue);W.hasBinding&&(S[R.id]=function(Y,Z,$){j(Z,W,$,J.text(Y))});}x.call(Q.attributes||[],function(Y){if(R.id++,!T[Y.name]){var Z=Y.name,$=n(Z),aa=h(Y.value);if(aa.hasBinding)S[R.id]=function(fa,ga,ha){return $?(fa.removeAttribute(Z),void j(ga,aa,ha,J.prop(fa,$))):void j(ga,aa,ha,J.attr(fa,Z))};else if($)S[R.id]=function(fa){fa.removeAttribute(Z),J.prop(fa,$)(Y.value)};else if('on-'===Z.substr(0,3)){var ba=Z.substr(3);S[R.id]=function(fa,ga,ha){fa.removeAttribute(Z),J.event(fa,ba,ga,aa,ha)}}}});var X=Q.childNodes;return x.call(X,function(Y){R.id++,k(Y,R,S)}),S}function m(Q){for(var R,S=0,T=K.length;S<T;S++)if(R=K[S],Q.getAttribute(R))return R}function n(Q){return Q&&':'===Q[0]&&Q.substr(1)}function p(Q){return class extends Q{constructor(){super();var R=this.constructor;let S=R.template;S&&(this._hydrate=N(S)),this._hasRendered=!1,this.model={};let T=R.events;T&&!R._hasSetupEvents&&q(R);let U=!R._hasInstalledProps&&R.observedProperties;U&&(R._hasInstalledProps=!0,r(R,U,R.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){E(this.model)||(this.model=D(this.model));var R=new H(this).add(this.model);this._link=this._hydrate(R);var S=this._link.tree,T=this.constructor.renderMode;'light'===T?(this.innerHTML='',this.appendChild(S)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(S)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=s(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(R,S,T){var U=this.constructor._syncedAttrs,V=U&&U[R];V&&this[R]!==T&&(this[R]=T)}}}function q(Q){Q._hasSetupEvents=!0,Q.events.forEach(function(R){Object.defineProperty(Q.prototype,'on'+R,{get:function(){return this['_on'+R]},set:function(S){var T='_on'+R,U=this[T];U&&this.removeEventListener(R,U),this[T]=S,this.addEventListener(R,S)}})})}function r(Q,R,S=[]){Q._syncedAttrs={};var T=Q.prototype;R.forEach(function(U){var V=Object.getOwnPropertyDescriptor(T,U);if(!V){var W=-1!==S.indexOf(U);W&&(Q._syncedAttrs[U]=!0),Object.defineProperty(T,U,{get:function(){return this.model[U]},set:function(X){if(this.model[U]=X,W){var Y=this.getAttribute(U);if('boolean'==typeof X)return void(X&&''!==Y?this.setAttribute(U,''):''===Y&&!X&&this.removeAttribute(U));Y!==X&&this.setAttribute(U,X)}}})}})}function s(Q){var R=!1,S=function(){R||Q.childrenConnectedCallback()};if(!P)return void w(S);var T=new MutationObserver(S);return T.observe(Q,{childList:!0}),Q.childNodes.length&&w(S),function(){R=!0,T.disconnect()}}var u='function'==typeof Symbol?Symbol:function(Q){return'@@-'+Q},v=Object.values||function(Q){return Object.keys(Q).reduce(function(R,S){return R.push(Q[S]),R},[])},w='function'==typeof Promise?Q=>Promise.resolve().then(Q):Q=>setTimeout(()=>Q(),0),x=Array.prototype.forEach,y=Array.prototype.some,z=Array.prototype.slice;class A{static add(Q){this.current=Q,this.stack.push(Q)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(Q,R){this.current&&this.current.stack.push([Q,R])}constructor(){this.stack=[]}start(){A.add(this)}stop(){return A.remove(),this.stack}}A.stack=[];var B=u('bram-events'),C=u('bram-array-change'),D=function(Q,R){if(E(Q))return Q;Q=f(Q,R)||{};return Object.defineProperty(Q,B,{value:{},enumerable:!1}),e(Q,function(T,U){var V=Q[B][T.prop];V&&V.forEach(function(W){W(T,U)})})},E=function(Q){return Q&&!!Q[B]},F=function(Q,R,S){var T=Q[B];if(T){var U=T[R];U||(U=T[R]=[]),U.push(S)}},G=function(Q,R,S){var T=Q[B];if(T){var U=T[R];if(U){var V=U.indexOf(S);-1===V||(U.splice(V,1),!U.length&&delete T[R])}}};class H{constructor(Q,R){this.model=Q,this.parent=R}read(Q){return this._read(Q)||{model:this.model,value:void 0}}readInTransaction(Q){var R=new A;R.start();var S=this.read(Q);return S.reads=R.stop(),S}_read(Q){var R=this.model,S=R[Q];if(null==S){// Handle dotted bindings like "user.name"
var T=Q.split('.');if(1<T.length)do S=R[T.shift()],T.length&&(R=S);while(T.length&&S)}return null==S?this.parent?this.parent.read(Q):void 0:{model:R,value:S}}add(Q){var R;if(E(Q))R=Q;else{R=Array.isArray(Q)||'object'==typeof Q?D(Q):Q}return new H(R,this)}}class I{constructor(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}getValue(Q){var R=this.props()[0];return Q.read(R).value}getStringValue(Q){for(var T,U,R=Object.keys(this.values).sort(function(V,W){return+V>+W?1:-1}),S=this.raw;R.length;)T=R.pop(),U=Q.read(this.values[T]).value,null!=U&&(S=S.substr(0,T)+U+S.substr(T));return S}compute(Q){var R=this.includesNonBindings||1<this.count();return R?this.getStringValue.bind(this,Q):this.getValue.bind(this,Q)}props(){return v(this.values)}count(){return!1===this.hasBinding?0:Object.keys(this.values).length}throwIfMultiple(Q){if(1<this.count())throw Q=Q||'Only a single binding is allowed in this context.',new Error(Q)}}var J={attr:function(Q,R){return function(S){Q.setAttribute(R,S)}},text:function(Q){return function(R){Q.nodeValue=R}},prop:function(Q,R){return function(S){Q[R]=S}},event:function(Q,R,S,T,U){var V=T.raw;U.bind(Q,R,function(W){var X=S.read(V);X.value.call(X.model,W)})},each:function(Q,R,S,T){var U=N(Q),V=S.props()[0],W=R.read(V),X=document.createTextNode('');Q.parentNode.replaceChild(X,Q);var Y=function($){var aa=new Map,ba=new Map,ca=function(fa,ga){var ha=R.add(fa).add({item:fa,index:ga}),ia=U(ha);T.add(ia);var ja=ia.tree,ka={item:fa,link:ia,nodes:z.call(ja.childNodes),scope:ha,index:ga};aa.set(fa,ka),ba.set(ga,ka);var la=ba.get(ga+1),ma=X.parentNode;if(la){var na=la.nodes[0];ma.insertBefore(ja,na)}else ma.appendChild(ja)},da=function(fa){var ga=ba.get(fa);ga&&(ga.nodes.forEach(function(ha){ha.parentNode.removeChild(ha)}),T.remove(ga.link),aa.delete(ga.item),ba.delete(fa))};$.forEach(ca);var ea=function(fa,ga){if('delete'===fa.type)return void da(fa.index);var ha=aa.get(ga);if(ha){var ia=ha.index,ja=ia!==fa.index;if(ja){ha.scope.model.index=ha.index=fa.index;var ka=ba.get(fa.index);ka?ba.set(ia,ka):ba.delete(ia),ba.set(fa.index,ha);var la=ba.get(fa.index+1);la&&(la=la.nodes[0]);for(var ma=ha.nodes.length-1;0<=ma;)X.parentNode.insertBefore(ha.nodes[ma],la),ma--}}else da(fa.index),ca(ga,fa.index)};return T.on($,C,ea),function(){for(var fa=0,ga=$.length;fa<ga;fa++)da(fa);T.off($,C,ea),aa=null,ba=null}},Z=Y(W.value);T.on(W.model,V,function($,aa){Z(),Z=Y(aa)})},if:function(Q,R,S){var T=N(Q),U=!1,V={},W=document.createTextNode('');return Q.parentNode.replaceChild(W,Q),function(X){if(!!U){var aa=W.parentNode,ba=W.nextSibling;X?V.children.forEach(function(ca){aa.insertBefore(ca,ba)}):V.children.forEach(function(ca){aa.removeChild(ca)})}else if(X){var Y=R.add(X),Z=T(Y);S.add(Z);var $=Z.tree;V.children=z.call($.childNodes),V.scope=Y,W.parentNode.insertBefore($,W.nextSibling),U=!0}}}},K=['if','each'];class L{constructor(){this.map=new Map}set(Q,R,S){let T=this.map.get(Q);T||(T=new Map,this.map.set(Q,T)),T.set(R,S)}delete(Q,R){let S=this.map.get(Q);S&&S.delete(R)}}class M{constructor(Q){this.tree=Q,this.models=new L,this.elements=new L,this.children=[]}loop(Q,R){for(let[S,T]of Q)R(S,T[0],T[1])}on(Q,R,S){this.models.set(Q,R,S),F(Q,R,S)}off(Q,R,S){this.models.delete(Q,R),G(Q,R,S)}bind(Q,R,S){this.elements.set(Q,R,S),Q.addEventListener(R,S)}attach(){this.loop(this.models,F),this.children.forEach(function(Q){Q.attach()})}detach(){this.loop(this.models,G),this.children.forEach(function(Q){Q.detach()})}add(Q){this.children.push(Q)}remove(Q){var R=this.children.indexOf(Q);this.children.splice(R,1)}}var N=function(Q){Q=Q instanceof HTMLTemplateElement?Q:document.querySelector(Q);var R=k(Q.content,{id:0},{});return function(S){S instanceof H||(S=new H(S));var T=document.importNode(Q.content,!0),U=new M(T);return g(U,R,S),U}},O=p(HTMLElement);p.Element=O,p.model=D,p.on=F,p.off=G,p.template=N;var P='function'==typeof MutationObserver;return p});

