var symbol='function'==typeof Symbol?Symbol:function(c){return'@@-'+c},values=Object.values||function(c){return Object.keys(c).reduce(function(d,e){return d.push(c[e]),d},[])},asap='function'==typeof Promise?c=>Promise.resolve().then(c):c=>setTimeout(()=>c(),0),forEach=Array.prototype.forEach,some=Array.prototype.some,slice=Array.prototype.slice;class Transaction{static add(c){this.current=c,this.stack.push(c)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(c,d){this.current&&this.current.stack.push([c,d])}constructor(){this.stack=[]}start(){Transaction.add(this)}stop(){return Transaction.remove(),this.stack}}Transaction.stack=[];function isArraySet(c,d){return Array.isArray(c)&&!isNaN(+d)}function isArrayOrObject(c){return Array.isArray(c)||'object'==typeof c}function observe(c,d){var e=new Proxy(c,{get:function(f,g){return Transaction.observe(e,g),f[g]},set:function(f,g,h){var j=f[g];// If the value hasn't changed, nothing else to do
return!(!isModel(h)&&isArrayOrObject(h)&&(h=toModel(h)),f[g]=h,h!==j)||(isArraySet(f,g)?d({prop:arrayChange,index:+g,type:'set'},h):d({prop:g,type:'set'},h),!0)},deleteProperty:function(f,g){return isArraySet(f,g)&&d({prop:arrayChange,index:+g,type:'delete'}),!0}});return e}var events=symbol('bram-events'),arrayChange=symbol('bram-array-change'),toModel=function(c,d){return isModel(c)?c:(c=deepModel(c,d)||{},Object.defineProperty(c,events,{value:{},enumerable:!1}),observe(c,function(e,f){var g=c[events][e.prop];g&&g.forEach(function(h){h(e,f)})}))};function deepModel(c){return c?Object.keys(c).reduce(function(d,e){var f=c[e];return d[e]=Array.isArray(f)||'object'==typeof f?toModel(f):f,d},c):c}var isModel=function(c){return c&&!!c[events]},on=function(c,d,e){var f=c[events];if(f){var g=f[d];g||(g=f[d]=[]),g.push(e)}},off=function(c,d,e){var f=c[events];if(f){var g=f[d];if(g){var h=g.indexOf(e);-1===h||(g.splice(h,1),!g.length&&delete f[d])}}};function Scope(c,d){this.model=c,this.parent=d}Scope.prototype.read=function(c){return this._read(c)||{model:this.model,value:void 0}},Scope.prototype.readInTransaction=function(c){var d=new Transaction;d.start();var e=this.read(c);return e.reads=d.stop(),e},Scope.prototype._read=function(c){var d=this.model,e=d[c];if(null==e){// Handle dotted bindings like "user.name"
var f=c.split('.');if(1<f.length)do e=d[f.shift()],f.length&&(d=e);while(f.length&&e)}return null==e?this.parent?this.parent.read(c):void 0:{model:d,value:e}},Scope.prototype.add=function(c){var d;return d=isModel(c)?c:Array.isArray(c)||'object'==typeof c?toModel(c):c,new Scope(d,this)};function hydrate(c,d,e){function f(l){if(k++,j===k){var m=d[j];m(l,e,c),j=+h.shift()}return!j}function g(l){var m,n=slice.call(l.attributes||[]);return(some.call(n,function(){if(m=f(l),m)return!0}),!m)&&(some.call(l.childNodes,function(p){return(m=f(p),!!m)||(m=!g(p),!!m)||void 0}),!m)}var h=Object.keys(d),j=+h.shift(),k=0;g(c.tree)}function ParseResult(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}ParseResult.prototype.getValue=function(c){var d=this.props()[0];return c.read(d).value},ParseResult.prototype.getStringValue=function(c){for(var f,g,d=Object.keys(this.values).sort(function(h,j){return+h>+j?1:-1}),e=this.raw;d.length;)f=d.pop(),g=c.read(this.values[f]).value,null!=g&&(e=e.substr(0,f)+g+e.substr(f));return e},ParseResult.prototype.compute=function(c){var d=this.includesNonBindings||1<this.count();return d?this.getStringValue.bind(this,c):this.getValue.bind(this,c)},ParseResult.prototype.props=function(){return values(this.values)},ParseResult.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},ParseResult.prototype.throwIfMultiple=function(c){if(1<this.count())throw c=c||'Only a single binding is allowed in this context.',new Error(c)};function parse(c){for(var k,d=0,e=c.length,f=new ParseResult,g=!1,h='',j=0;d<e;){if(h=k,k=c[d],!g){if('{'===k){'{'==h&&(f.hasBinding=!0,j=f.raw.length,null!=f.values[j]&&j++,f.values[j]='',g=!0),d++;continue}else'{'==h&&(f.raw+=h);f.raw+=k}else{if('}'===k){'}'==h&&(g=!1),d++;continue}f.values[j]+=k}d++}return f.includesNonBindings=0<f.raw.length,f}var live={attr:function(c,d){return function(e){c.setAttribute(d,e)}},text:function(c){return function(d){c.nodeValue=d}},prop:function(c,d){return function(e){c[d]=e}},event:function(c,d,e,f,g){var h=f.raw;g.bind(c,d,function(j){var k=e.read(h);k.value.call(k.model,j)})},each:function(c,d,e,f){var g=stamp(c),h=e.props()[0],j=d.read(h),k=document.createTextNode('');c.parentNode.replaceChild(k,c);var l=function(n){var p=new Map,q=new Map,r=function(v,w){var x=d.add(v).add({item:v,index:w}),y=g(x);f.add(y);var z=y.tree,A={item:v,link:y,nodes:slice.call(z.childNodes),scope:x,index:w};p.set(v,A),q.set(w,A);var B=q.get(w+1),C=k.parentNode;if(B){var D=B.nodes[0];C.insertBefore(z,D)}else C.appendChild(z)},s=function(v){var w=q.get(v);w&&(w.nodes.forEach(function(x){x.parentNode.removeChild(x)}),f.remove(w.link),p.delete(w.item),q.delete(v))};n.forEach(r);var u=function(v,w){if('delete'===v.type)return void s(v.index);var x=p.get(w);if(x){var y=x.index,z=y!==v.index;if(z){x.scope.model.index=x.index=v.index;var A=q.get(v.index);A?q.set(y,A):q.delete(y),q.set(v.index,x);var B=q.get(v.index+1);B&&(B=B.nodes[0]);for(var C=x.nodes.length-1;0<=C;)k.parentNode.insertBefore(x.nodes[C],B),C--}}else s(v.index),r(w,v.index)};return f.on(n,arrayChange,u),function(){for(var v=0,w=n.length;v<w;v++)s(v);f.off(n,arrayChange,u),p=null,q=null}},m=l(j.value);f.on(j.model,h,function(n,p){m(),m=l(p)})},if:function(c,d,e){var f=stamp(c),g=!1,h={},j=document.createTextNode('');return c.parentNode.replaceChild(j,c),function(k){if(!!g){var p=j.parentNode,q=j.nextSibling;k?h.children.forEach(function(r){p.insertBefore(r,q)}):h.children.forEach(function(r){p.removeChild(r)})}else if(k){var l=d.add(k),m=f(l);e.add(m);var n=m.tree;h.children=slice.call(n.childNodes),h.scope=l,j.parentNode.insertBefore(n,j.nextSibling),g=!0}}}};function setupBinding(c,d,e,f){var g=d.compute(c),h=function(){f(g())};d.props().forEach(function(j){var k=c.readInTransaction(j);k.model,!1!==k.bindable&&k.reads.forEach(function(l){e.on(l[0],l[1],h)})}),h()}function inspect(c,d,e){var f={};switch(c.nodeType){// Element
case 1:var g;if('TEMPLATE'===c.nodeName&&(g=specialTemplateAttr(c))){var h=parse(c.getAttribute(g));h.hasBinding&&(h.throwIfMultiple(),f[g]=!0,e[d.id]=function(k,l,m){'each'===g?live.each(k,l,h,m):setupBinding(l,h,m,live[g](k,l,m))})}break;// TextNode
case 3:var h=parse(c.nodeValue);h.hasBinding&&(e[d.id]=function(k,l,m){setupBinding(l,h,m,live.text(k))});}forEach.call(c.attributes||[],function(k){if(d.id++,!f[k.name]){var l=k.name,m=propAttr(l),n=parse(k.value);if(n.hasBinding)e[d.id]=function(u,y,z){return m?(u.removeAttribute(l),void setupBinding(y,n,z,live.prop(u,m))):void setupBinding(y,n,z,live.attr(u,l))};else if(m)e[d.id]=function(u){u.removeAttribute(l),live.prop(u,m)(k.value)};else if('on-'===l.substr(0,3)){var p=l.substr(3);e[d.id]=function(u,y,z){u.removeAttribute(l),live.event(u,p,y,n,z)}}}});var j=c.childNodes;return forEach.call(j,function(k){d.id++,inspect(k,d,e)}),e}var specialTemplateAttrs=['if','each'];function specialTemplateAttr(c){var d;for(var e=0,f=specialTemplateAttrs.length;e<f;e++)if(d=specialTemplateAttrs[e],c.getAttribute(d))return d}function propAttr(c){return c&&':'===c[0]&&c.substr(1)}class MapOfMap{constructor(){this.map=new Map}set(c,d,e){let f=this.map.get(c);f||(f=new Map,this.map.set(c,f)),f.set(d,e)}delete(c,d){let e=this.map.get(c);e&&e.delete(d)}}class Link{constructor(c){this.tree=c,this.models=new MapOfMap,this.elements=new MapOfMap,this.children=[]}loop(c,d){for(let[e,f]of c)d(e,f[0],f[1])}on(c,d,e){this.models.set(c,d,e),on(c,d,e)}off(c,d,e){this.models.delete(c,d),off(c,d,e)}bind(c,d,e){this.elements.set(c,d,e),c.addEventListener(d,e)}attach(){this.loop(this.models,on),this.children.forEach(function(c){c.attach()})}detach(){this.loop(this.models,off),this.children.forEach(function(c){c.detach()})}add(c){this.children.push(c)}remove(c){var d=this.children.indexOf(c);this.children.splice(d,1)}}var stamp=function(c){c=c instanceof HTMLTemplateElement?c:document.querySelector(c);var d=inspect(c.content,{id:0},{});return function(e){e instanceof Scope||(e=new Scope(e));var f=document.importNode(c.content,!0),g=new Link(f);return hydrate(g,d,e),g}};function Bram(c){return class extends c{constructor(){super();var d=this.constructor;let e=d.template;e&&(this._hydrate=stamp(e)),this._hasRendered=!1,this.model={};let f=d.events;f&&!d._hasSetupEvents&&installEvents(d);let g=!d._hasInstalledProps&&d.observedProperties;g&&(d._hasInstalledProps=!0,installProps(d,g,d.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){isModel(this.model)||(this.model=toModel(this.model));var d=new Scope(this).add(this.model);this._link=this._hydrate(d);var e=this._link.tree,f=this.constructor.renderMode;'light'===f?(this.innerHTML='',this.appendChild(e)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(e)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=setupChildMO(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(d,e,f){var g=this.constructor._syncedAttrs,h=g&&g[d];h&&this[d]!==f&&(this[d]=f)}}}var Element=Bram(HTMLElement);Bram.Element=Element,Bram.model=toModel,Bram.on=on,Bram.off=off,Bram.template=stamp;function installEvents(c){c._hasSetupEvents=!0,c.events.forEach(function(d){Object.defineProperty(c.prototype,'on'+d,{get:function(){return this['_on'+d]},set:function(e){var f='_on'+d,g=this[f];g&&this.removeEventListener(d,g),this[f]=e,this.addEventListener(d,e)}})})}function installProps(c,d,e=[]){c._syncedAttrs={};var f=c.prototype;d.forEach(function(g){var h=Object.getOwnPropertyDescriptor(f,g);if(!h){var j=-1!==e.indexOf(g);j&&(c._syncedAttrs[g]=!0),Object.defineProperty(f,g,{get:function(){return this.model[g]},set:function(k){if(this.model[g]=k,j){var l=this.getAttribute(g);'boolean'==typeof k?k&&''!==l?this.setAttribute(g,''):''===l&&!k&&this.removeAttribute(g):l!==k&&this.setAttribute(g,k)}}})}})}var SUPPORTS_MO='function'==typeof MutationObserver;function setupChildMO(c){var d=!1,e=function(){d||c.childrenConnectedCallback()};if(!SUPPORTS_MO)return void asap(e);var f=new MutationObserver(e);return f.observe(c,{childList:!0}),c.childNodes.length&&asap(e),function(){d=!0,f.disconnect()}}export{Element};export default Bram;

