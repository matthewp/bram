var symbol='function'==typeof Symbol?Symbol:function(c){return'@@-'+c},values=Object.values||function(c){return Object.keys(c).reduce(function(d,e){return d.push(c[e]),d},[])},asap='function'==typeof Promise?c=>Promise.resolve().then(c):c=>setTimeout(()=>c(),0),forEach=Array.prototype.forEach,some=Array.prototype.some,slice=Array.prototype.slice;class Transaction{static add(c){this.current=c,this.stack.push(c)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(c,d){this.current&&this.current.stack.push([c,d])}constructor(){this.stack=[]}start(){Transaction.add(this)}stop(){return Transaction.remove(),this.stack}}Transaction.stack=[];function isArraySet(c,d){return Array.isArray(c)&&!isNaN(+d)}function isArrayOrObject(c){return Array.isArray(c)||'object'==typeof c}function observe(c,d){var e=new Proxy(c,{get:function(f,g){return Transaction.observe(e,g),f[g]},set:function(f,g,h){var j=f[g];// If the value hasn't changed, nothing else to do
return!(!isModel(h)&&isArrayOrObject(h)&&(h=toModel(h)),f[g]=h,h!==j)||(isArraySet(f,g)?d({prop:arrayChange,index:+g,type:'set'},h):d({prop:g,type:'set'},h),!0)},deleteProperty:function(f,g){return isArraySet(f,g)&&d({prop:arrayChange,index:+g,type:'delete'}),!0}});return e}var events=symbol('bram-events'),arrayChange=symbol('bram-array-change'),toModel=function(c,d){if(isModel(c))return c;c=deepModel(c,d)||{};return Object.defineProperty(c,events,{value:{},enumerable:!1}),observe(c,function(f,g){var h=c[events][f.prop];h&&h.forEach(function(j){j(f,g)})})};function deepModel(c){return c?Object.keys(c).reduce(function(e,f){var g=c[f];return e[f]=Array.isArray(g)||'object'==typeof g?toModel(g):g,e},c):c}var isModel=function(c){return c&&!!c[events]},on=function(c,d,e){var f=c[events];if(f){var g=f[d];g||(g=f[d]=[]),g.push(e)}},off=function(c,d,e){var f=c[events];if(f){var g=f[d];if(g){var h=g.indexOf(e);-1===h||(g.splice(h,1),!g.length&&delete f[d])}}};class Scope{constructor(c,d){this.model=c,this.parent=d}read(c){return this._read(c)||{model:this.model,value:void 0}}readInTransaction(c){var d=new Transaction;d.start();var e=this.read(c);return e.reads=d.stop(),e}_read(c){var d=this.model,e=d[c];if(null==e){// Handle dotted bindings like "user.name"
var f=c.split('.');if(1<f.length)do e=d[f.shift()],f.length&&(d=e);while(f.length&&e)}return null==e?this.parent?this.parent.read(c):void 0:{model:d,value:e}}add(c){var d;if(isModel(c))d=c;else{d=Array.isArray(c)||'object'==typeof c?toModel(c):c}return new Scope(d,this)}}function hydrate(c,d,e){var h=Object.keys(d);if(0!==h.length){function s(v){if(k++,j===k){var w=d[j];w(v,e,c),j=+h.shift()}return!j}function u(v){var w,x=slice.call(v.attributes||[]);if(some.call(x,function(){if(w=s(v),w)return!0}),w)return!1;for(var z,y=v.firstChild;y&&(z=y.nextSibling,w=s(y),!w)&&(w=!u(y),!w);)y=z;return!w}var j=+h.shift(),k=0;u(c.tree)}}class ParseResult{constructor(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}getValue(c){var d=this.props()[0];return c.read(d).value}getStringValue(c){for(var f,g,d=Object.keys(this.values).sort(function(h,j){return+h>+j?1:-1}),e=this.raw;d.length;)f=d.pop(),g=c.read(this.values[f]).value,null!=g&&(e=e.substr(0,f)+g+e.substr(f));return e}compute(c){var d=this.includesNonBindings||1<this.count();return d?this.getStringValue.bind(this,c):this.getValue.bind(this,c)}props(){return values(this.values)}count(){return!1===this.hasBinding?0:Object.keys(this.values).length}throwIfMultiple(c){if(1<this.count())throw c=c||'Only a single binding is allowed in this context.',new Error(c)}}function parse(c){for(var k,d=0,e=c.length,f=new ParseResult,g=!1,h='',j=0;d<e;){if(h=k,k=c[d],!g){if('$'===k){d++;continue}else if('{'===k&&'$'==h){f.hasBinding=!0,j=f.raw.length,null!=f.values[j]&&j++,f.values[j]='',g=!0,d++;continue}else'$'==h&&(f.raw+=h);f.raw+=k}else{if(g&&'}'===k){g=!1,d++;continue}f.values[j]+=k}d++}return f.includesNonBindings=0<f.raw.length,f}var live={attr:function(c,d){return function(e){c.setAttribute(d,e)}},text:function(c){return function(d){c.nodeValue=d}},prop:function(c,d){return function(e){c[d]=e}},event:function(c,d,e,f,g){var h=f.raw;g.bind(c,d,function(j){var k=e.read(h);k.value.call(k.model,j)})},each:function(c,d,e,f){var g=stamp(c),h=e.props()[0],j=d.read(h),k=document.createTextNode('');c.parentNode.replaceChild(k,c);var m=function(p){var q=new Map,r=new Map,s=function(w,x){var y=d.add(w).add({item:w,index:x}),z=g(y);f.add(z);var A=z.tree,B={item:w,link:z,nodes:slice.call(A.childNodes),scope:y,index:x};q.set(w,B),r.set(x,B);var C=r.get(x+1),D=k.parentNode;if(C){var E=C.nodes[0];D.insertBefore(A,E)}else D.appendChild(A)},u=function(w){var x=r.get(w);x&&(x.nodes.forEach(function(y){y.parentNode.removeChild(y)}),f.remove(x.link),q.delete(x.item),r.delete(w))};p.forEach(s);var v=function(w,x){if('delete'===w.type)return void u(w.index);var y=q.get(x);if(y){var z=y.index,A=z!==w.index;if(A){y.scope.model.index=y.index=w.index;var B=r.get(w.index);B?r.set(z,B):r.delete(z),r.set(w.index,y);var C=r.get(w.index+1);C&&(C=C.nodes[0]);for(var D=y.nodes.length-1;0<=D;)k.parentNode.insertBefore(y.nodes[D],C),D--}}else u(w.index),s(x,w.index)};return f.on(p,arrayChange,v),function(){for(var w=0,x=p.length;w<x;w++)u(w);f.off(p,arrayChange,v),q=null,r=null}},n=m(j.value);f.on(j.model,h,function(p,q){n(),n=m(q)})},if:function(c,d,e){var f=stamp(c),g=!1,h={},j=document.createTextNode('');return c.parentNode.replaceChild(j,c),function(k){if(!!g){var q=j.parentNode,r=j.nextSibling;k?h.children.forEach(function(s){q.insertBefore(s,r)}):h.children.forEach(function(s){q.removeChild(s)})}else if(k){var m=d.add(k),n=f(m);e.add(n);var p=n.tree;h.children=slice.call(p.childNodes),h.scope=m,j.parentNode.insertBefore(p,j.nextSibling),g=!0}}}};function setupBinding(c,d,e,f){var g=d.compute(c),h=function(){f(g())};d.props().forEach(function(j){var k=c.readInTransaction(j),m=k.model;if(!1!==k.bindable){var n=new Map;k.reads.forEach(function(p){var q=p[0],r=p[1];if(n.has(q)){var s=n.get(q);if(s.has(r))return;s.set(r,!0)}else{var s=new Map;s.set(r,!0),n.set(q,s)}e.on(q,r,h)})}}),h()}function inspect(c,d,e){var f={};switch(c.nodeType){// Element
case 1:var g;if('TEMPLATE'===c.nodeName&&(g=specialTemplateAttr(c))){var h=c.getAttribute(g),j=parse('${'+h+'}');j.hasBinding&&(j.throwIfMultiple(),f[g]=!0,e[d.id]=function(m,n,p){'each'===g?live.each(m,n,j,p):setupBinding(n,j,p,live[g](m,n,p))})}break;// TextNode
case 3:var j=parse(c.nodeValue);j.hasBinding&&(e[d.id]=function(m,n,p){setupBinding(n,j,p,live.text(m))});}forEach.call(c.attributes||[],function(m){if(d.id++,!f[m.name]){var n=m.name,p=propAttr(n),q=parse(m.value);if(q.hasBinding)e[d.id]=function(z,A,B){return p?(z.removeAttribute(n),void setupBinding(A,q,B,live.prop(z,p))):void setupBinding(A,q,B,live.attr(z,n))};else if(p)e[d.id]=function(z){z.removeAttribute(n),live.prop(z,p)(m.value)};else if('on-'===n.substr(0,3)){var r=n.substr(3);e[d.id]=function(z,A,B){z.removeAttribute(n),live.event(z,r,A,q,B)}}}});var k=c.childNodes;return forEach.call(k,function(m){d.id++,inspect(m,d,e)}),e}var specialTemplateAttrs=['if','each'];function specialTemplateAttr(c){for(var d,e=0,f=specialTemplateAttrs.length;e<f;e++)if(d=specialTemplateAttrs[e],c.getAttribute(d))return d}function propAttr(c){return c&&':'===c[0]&&c.substr(1)}class MapOfMap{constructor(){this.map=new Map}set(c,d,e){let f=this.map.get(c);f||(f=new Map,this.map.set(c,f)),f.set(d,e)}delete(c,d){let e=this.map.get(c);e&&e.delete(d)}}class Link{constructor(c){this.tree=c,this.models=new MapOfMap,this.elements=new MapOfMap,this.children=[]}loop(c,d){for(let[e,f]of c)d(e,f[0],f[1])}on(c,d,e){this.models.set(c,d,e),on(c,d,e)}off(c,d,e){this.models.delete(c,d),off(c,d,e)}bind(c,d,e){this.elements.set(c,d,e),c.addEventListener(d,e)}attach(){this.loop(this.models,on),this.children.forEach(function(c){c.attach()})}detach(){this.loop(this.models,off),this.children.forEach(function(c){c.detach()})}add(c){this.children.push(c)}remove(c){var d=this.children.indexOf(c);this.children.splice(d,1)}}var stamp=function(c){c=c instanceof HTMLTemplateElement?c:document.querySelector(c);var d=inspect(c.content,{id:0},{});return function(e){e instanceof Scope||(e=new Scope(e));var f=document.importNode(c.content,!0),g=new Link(f);return hydrate(g,d,e),g}};function Bram(c){return class extends c{constructor(){super();var d=this.constructor;let e=d.template;e&&(this._hydrate=stamp(e)),this._hasRendered=!1,this.model={};let f=d.events;f&&!d._hasSetupEvents&&installEvents(d);let g=!d._hasInstalledProps&&d.observedProperties;g&&(d._hasInstalledProps=!0,installProps(d,g,d.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){isModel(this.model)||(this.model=toModel(this.model));var d=new Scope(this).add(this.model);this._link=this._hydrate(d);var e=this._link.tree,f=this.constructor.renderMode;'light'===f?(this.innerHTML='',this.appendChild(e)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(e)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=setupChildMO(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(d,e,f){var g=this.constructor._syncedAttrs,h=g&&g[d];h&&this[d]!==f&&(this[d]=f)}}}var Element=Bram(HTMLElement);Bram.Element=Element,Bram.model=toModel,Bram.on=on,Bram.off=off,Bram.template=stamp;function installEvents(c){c._hasSetupEvents=!0,c.events.forEach(function(d){Object.defineProperty(c.prototype,'on'+d,{get:function(){return this['_on'+d]},set:function(e){var f='_on'+d,g=this[f];g&&this.removeEventListener(d,g),this[f]=e,this.addEventListener(d,e)}})})}function installProps(c,d,e=[]){c._syncedAttrs={};var f=c.prototype;d.forEach(function(g){var h=Object.getOwnPropertyDescriptor(f,g);if(!h){var j=-1!==e.indexOf(g);j&&(c._syncedAttrs[g]=!0),Object.defineProperty(f,g,{get:function(){return this.model[g]},set:function(k){if(this.model[g]=k,j){var m=this.getAttribute(g);if('boolean'==typeof k)return void(k&&''!==m?this.setAttribute(g,''):''===m&&!k&&this.removeAttribute(g));m!==k&&this.setAttribute(g,k)}}})}})}var SUPPORTS_MO='function'==typeof MutationObserver;function setupChildMO(c){var d=!1,e=function(){d||c.childrenConnectedCallback()};if(!SUPPORTS_MO)return void asap(e);var f=new MutationObserver(e);return f.observe(c,{childList:!0}),c.childNodes.length&&asap(e),function(){d=!0,f.disconnect()}}export{Element};export default Bram;

